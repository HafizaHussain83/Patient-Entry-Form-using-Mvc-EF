@model ProductDto
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Create Patient";
    var rooms = ViewBag.Rooms as List<Room>;
}

<div class="container mt-5">
    <div class="col-md-8 mx-auto shadow-lg p-4 rounded-3 bg-light">
        <h2 class="text-center mb-4 text-primary fw-bold">New Patient Registration</h2>

        <form asp-action="Create" method="post">
            <div class="row g-3">

                <!-- Name -->
                <div class="col-md-6">
                    <label asp-for="name" class="form-label fw-semibold"></label>
                    <input asp-for="name" class="form-control shadow-sm" placeholder="Enter full name" />
                    <span asp-validation-for="name" class="text-danger small"></span>
                </div>

                <!-- Age -->
                <div class="col-md-3">
                    <label asp-for="age" class="form-label fw-semibold"></label>
                    <input asp-for="age" class="form-control shadow-sm" type="number" placeholder="Age" />
                    <span asp-validation-for="age" class="text-danger small"></span>
                </div>

                <!-- Sex -->
                <div class="col-md-3">
                    <label asp-for="sex" class="form-label fw-semibold"></label>
                    <select asp-for="sex" class="form-select shadow-sm">
                        <option value="">-- Select --</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Others">Others</option>
                    </select>
                    <span asp-validation-for="sex" class="text-danger small"></span>
                </div>

                <!-- Address -->
                <div class="col-md-6">
                    <label asp-for="address" class="form-label fw-semibold"></label>
                    <input asp-for="address" class="form-control shadow-sm" placeholder="Street, House No, etc." />
                    <span asp-validation-for="address" class="text-danger small"></span>
                </div>

                <!-- City -->
                <div class="col-md-6">
                    <label asp-for="city" class="form-label fw-semibold"></label>
                    <input asp-for="city" class="form-control shadow-sm" placeholder="City" />
                    <span asp-validation-for="city" class="text-danger small"></span>
                </div>

                <!-- Phone -->
                <div class="col-md-6">
                    <label asp-for="phone_number" class="form-label fw-semibold"></label>
                    <input asp-for="phone_number" class="form-control shadow-sm" placeholder="+92XXXXXXXXXX" />
                    <span asp-validation-for="phone_number" class="text-danger small"></span>
                </div>

                <!-- Entry Date -->
                <div class="col-md-6">
                    <label asp-for="entry_date" class="form-label fw-semibold"></label>
                    <input asp-for="entry_date" type="date" class="form-control shadow-sm" />
                    <span asp-validation-for="entry_date" class="text-danger small"></span>
                </div>

                <!-- Doctor Selection -->
                <div class="col-md-6">
                    <label asp-for="referencing_doctor_id" class="form-label fw-semibold">Select Doctor</label>
                    <select asp-for="referencing_doctor_id"
                            asp-items="@(new SelectList(ViewBag.DoctorsList, "DoctorId", "DoctorName"))"
                            class="form-select shadow-sm" id="doctorDropdown">
                        <option value="">-- Select --</option>
                    </select>
                    <span asp-validation-for="referencing_doctor_id" class="text-danger small"></span>
                </div>

                <!-- Doctor ID & Department -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Doctor ID</label>
                    <input class="form-control shadow-sm" id="doctorId" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Department</label>
                    <input class="form-control shadow-sm" id="departmentName" readonly />
                </div>

                <!-- Diagnosis -->
                <div class="col-12">
                    <label asp-for="diagnosis" class="form-label fw-semibold"></label>
                    <input asp-for="diagnosis" class="form-control shadow-sm" placeholder="Diagnosis details" />
                    <span asp-validation-for="diagnosis" class="text-danger small"></span>
                </div>

                <!-- ROOM PICKER -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Room / Bed</label>
                    <div class="input-group">
                        <input id="selectedRoomText" class="form-control shadow-sm" placeholder="No room selected" readonly />
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#roomModal">Pick</button>
                    </div>
                    <input asp-for="Room_id" id="Room_id" type="hidden" />
                    <span asp-validation-for="Room_id" class="text-danger small"></span>
                </div>

                <!-- Submit Button -->
                <div class="col-12 text-center mt-3">
                    <button type="submit" class="btn btn-primary btn-lg shadow-sm px-5">Save Patient</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ROOM MODAL -->
<div class="modal fade" id="roomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="roomModalLabel">Available Room List</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Action</th>
                                <th>RoomNo</th>
                                <th>BedNo</th>
                                <th>Floor</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in rooms)
                            {
                                <tr>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary select-room"
                                                data-room-id="@r.Room_id"
                                                data-roomno="@r.RoomNo"
                                                data-bed="@r.BedNo"
                                                data-floor="@r.Floor">
                                            Select
                                        </button>
                                    </td>
                                    <td>@r.RoomNo</td>
                                    <td>@r.BedNo</td>
                                    <td>@r.Floor</td>
                                </tr>
                            }
                            @if (rooms == null || rooms.Count == 0)
                            {
                                <tr><td colspan="4" class="text-center text-muted p-4">No rooms available</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Dr. helper
        var doctorMap = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.DoctorMap));

        function fillDoctorFields() {
            var selectedId = document.getElementById("doctorDropdown").value;
            if (doctorMap[selectedId]) {
                document.getElementById("doctorId").value = selectedId;
                document.getElementById("departmentName").value = doctorMap[selectedId].DepartmentId ?? "";
            } else {
                document.getElementById("doctorId").value = "";
                document.getElementById("departmentName").value = "";
            }
        }
        document.getElementById("doctorDropdown").addEventListener("change", fillDoctorFields);
        document.addEventListener("DOMContentLoaded", fillDoctorFields);

        // Room picker
        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("select-room")) {
                const btn = e.target;
                const id = btn.dataset.roomId;
                const display = `${btn.dataset.roomno} - Bed ${btn.dataset.bed} (${btn.dataset.floor})`;

                document.getElementById("Room_id").value = id;
                document.getElementById("selectedRoomText").value = display;

                const modalEl = document.getElementById('roomModal');
                const instance = bootstrap.Modal.getInstance(modalEl);
                instance.hide();
            }
        });
    </script>
}
